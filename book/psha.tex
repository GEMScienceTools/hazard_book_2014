This chapter describes the mathematical framework for PSHA implemented by the OpenQuake-engine.
Seismicity is assumed to be described as a time-indipendent Poissonian process. Seismicity modeling
relies therefore on the following three assumptions:
\begin{itemize}
	\item seismicity in a region is described by a collection of \textit{indipendent seismic sources}
	(i.e. the occurrence of an earthquake rupture in a source does not affect the probability of
	earthquake occurrence in the other sources)
	\item each source generates \textit{indipendent earthquake ruptures} (i.e. the occurrence of an
	earthquake rupture in a source does not affect the probability of occurrence of the other
	potential earthquake ruptures in the same source)
	\item the number of occurrences for each earthquake rupture in a source follows a \textit{Poissonian}
	distribution
\end{itemize}

\section{Basic concepts}
The Classical, Event-Based, and Disaggregation analysis requires the definition of two main components:
the \textit{seismic source model}, that is a collection of seismic sources describing the seismic activity in a
region of interest, and the \textit{ground motion model}, that is a mathematical relationship defining the
probability distribution of a ground motion parameter at a site given the occurrence of an earthquake
rupture.\\
The design of a seismic source model involves the specification of a number of sources whose main parameters
are the geometry, constraining the earthquake rupture locations, and the \textit{magnitude-frequency
distribution}, defining the average annual occurrence rate over a magnitude range. Chapter \ref{chap:ssm} provides
a detailed description of the different source typologies supported by the OQ-engine. However, indipendently
of the typology, in a PSHA each source undergoes a discretization process which effectively generates a
number of distinct earthquake ruptures. We can therefore assume a source to define a set of earthquake ruptures:
\begin{equation}
Src = \left\{Rup_{1}, Rup_{2}, ..., Rup_{J}\right\}
\end{equation}
By indicating with $\nu_{j}$ the average annual occurrence rate for the $j-th$ rupture, the probability of the
$j-th$ rupture to occur $k$ times in a time span $T$ can be written, accordingly with the Poissonian assumption,
as:
\begin{equation}
\label{eq:poisson_pd}
P_{rup_{j}}(k | T) = e^{-\nu_{j} T} \frac{(\nu_{j} T) ^ {k}}{k!}
\end{equation}

\section{The hazard equation for \textit{Classical} PSHA}
The classical PSHA analysis allows calculating the probabilities of exceeding, at least once in a given time
span, and at a given site, a set of ground motion parameter levels considering all possible earthquake ruptures
defined in a seismic source model. Such a list of probability values is usually referred to as \textit{hazard curve}.
We indicate with $P(X \ge x | T)$ the probability that a ground-motion parameter $X$ exceeds, at least once in
a time span $T$, a level $x$. $P(X \ge x | T)$ can be computed as 1 minus the probability that none of the
sources is causing a ground motion exceedance. By assuming \textit{indipendent sources}, the probability
that none of the sources is causing an exceedance is equal to the product of the probabilities that each source
does not cause an exceedance, that is:
\begin{align}
\label{eq:hazard_eq}
P(X \ge x | T) & =  1 - P_{src1}(X < x | T) * P_{src2}(X < x | T) * ... * P_{srcI}(X < x | T) \nonumber \\
		      & =  1 - \prod_{i=1}^{I} P_{src_{i}}(X < x | T)
\end{align}
where $P_{src_{i}}(X < x | T)$ is the probability that the $i-th$ source is not causing an exceedance and $I$ is the
total number of sources in the source model. By further assuming each source generates \textit{indipendent
earthquake ruptures}, we can compute $P_{src_{i}}(X < x | T)$ as the product of the probabilities that each rupture
does not cause an exceedance, that is:
\begin{align}
\label{eq:prup_noexceed_src}
P_{src_{i}}(X < x | T) & = P_{rup_{1}}(X < x | T) * P_{rup_{2}}(X < x | T) * ... * P_{rup_{J}}(X < x | T) \nonumber \\
			        & = \prod_{j=1}^{J} P_{rup_{j}}(X < x | T)
\end{align}
where $P_{rup_{j}}(X < x | T)$ is the probability that the $j-th$ rupture is not causing an exceedance and $J$ is
the total number of ruptures generated by the source. Intuitively, the fact that a rupture does not cause any
exceedance in a given time span T can be due to the fact that the rupture does not occur at all or that the
rupture occurs once but without causing an exceedance, or that the rupture occurs twice but both times
without causing an exceedance, and so on. Given that all these events are mutually exclusive, by using the
total probability theorem we can write:
\begin{align}
\label{eq:prup_noexceed_rup}
P_{rup_{j}}(X < x | T) & = P_{rup_{j}}(n = 0 | T) + P_{rup_{j}}(n = 1 | T) * P(X < x | rup_{j}) + \nonumber \\
                                &\quad	P_{rup_{j}}(n = 2 | T) * P(X < x | rup_{j})^{2}  + ... \nonumber \\
				 & = \sum_{k=0}^{\infty} P_{rup_{j}}(k | T) * P(X < x | rup_{j}) ^ {k} 
\end{align}
where $P_{rup_{j}}(k | T)$ is the probability that the $j-th$ rupture is occurring $k$ times in time span $T$ and
$P(X < x | rup_{j})$ is the conditional probability that parameter $X$ is not exceeding level $x$ given an
occurrence of the $j-th$ rupture.\\
By now assuming that the \textit{number of occurrences of each rupture in a time span $T$ follows a Poissonian distribution}
we can place equation \ref{eq:poisson_pd} in \ref{eq:prup_noexceed_rup} and thus write:
\begin{align}
\label{eq:prup_noexceed_rup_pois_v0}
P_{rup_{j}}(X < x | T) & = \sum_{k=0}^{\infty} e^{-\nu_{j} T} \frac{(\nu_{j} T) ^ {k}}{k!} * P(X < x | rup_{j}) ^ {k} \nonumber \\
				 & =  e^{-\nu_{j} T} \sum_{k=0}^{\infty} \frac{(\nu_{j} T * P(X < x | rup_{j})) ^ {k}}{k!}
\end{align}
Making use of the property:
\begin{equation}
e^{x} = \sum_{k=0} ^ {\infty} \frac{x^{k}}{k!}
\end{equation}
we can rewrite \ref{eq:prup_noexceed_rup_pois_v0} as:
\begin{align}
\label{eq:prup_noexceed_rup_pois_v1}
P_{rup_{j}}(X < x | T) & = e^{-\nu_{j} T} e ^ {\nu_{j} T * P(X < x | rup_{j})} \nonumber \\
				 & = e^{-\nu_{j} T * (1 - P(X < x | rup_{j}))} \nonumber \\
				 & = e^{-\nu_{j} T * P(X \ge x | rup_{j})}
\end{align}
By now recognizing that, according to the Poissonian distribution, the probability of at least one occurrence
(that is one or more) in a time span $T$ of the $j-th$ rupture can be written as:
\begin{equation}
P_{rup_{j}}(n \ge 1 | T) = 1 -  e^{-\nu_{j} T}
\end{equation}
we can write equation \ref{eq:prup_noexceed_rup_pois_v1} as:
\begin{equation}
\label{eq:prup_noexceed_rup_pois_v2}
P_{rup_{j}}(X < x | T) = (1 - P_{rup_{j}}(n \ge 1 | T))^{P(X \ge x | rup_{j})}
\end{equation}
By placing equation \ref{eq:prup_noexceed_rup_pois_v2} in \ref{eq:prup_noexceed_src}, we can thus
write equation \ref{eq:hazard_eq} as:
\begin{equation}
\label{eq:hazard_eq_poiss}
P(X \ge x | T) =  1 - \prod_{i=1}^{I} \prod_{j=1}^{J} (1 - P_{rup_{j}}(n \ge 1 | T))^{P(X \ge x | rup_{j})}
\end{equation}
Equation \ref{eq:hazard_eq_poiss} is used by the OQ-engine for the calculation of hazard curves when performing
\textit{Classical} PSHA. To our knowledge, this equation has been first proposed by \cite{field2003},
derived from the traditional rate-based formulation converted in terms of probabilities (their equation A8).
Instead, we derive it from the assumptions of a source model consisting of independent sources, independent
earthquake ruptures generated by each source, and ruptures obeying to a Poissonian temporal occurrence model.

\subsection{Equivalence with the rate-based equation}
It is worth noticing how equation \ref{eq:hazard_eq_poiss} is equivalent to the more traditional rate-based
hazard equation (\cite{mcguire1995}). Indeed, by assuming ground motion occurrence to follow a Poissonian
distribution in time, and indicating with $\nu$ the mean annual rate of exceeding a ground motion level x,
we can write:
\begin{equation}
\label{eq:hazard_eq_rate}
P(X \ge x | T) = 1 - e ^ {- \nu T}
\end{equation}
We can also rewrite \ref{eq:hazard_eq_poiss} as:
\begin{align}
\label{eq:hazard_eq_prob}
P(X \ge x | T) &= 1 - \prod_{i=1}^{I} \prod_{j=1}^{J} (1 - P_{rup_{j}}(n \ge 1 | T))^{P(X \ge x | rup_{j})} \nonumber \\
		      &= 1 - \prod_{i=1}^{I} \prod_{j=1}^{J} e^{-\nu_{j} T * P(X \ge x | rup_{j})} \nonumber \\
		      & = 1 - e ^ {- \sum_{i=1}^{I} \sum_{j=1}^{J} \nu_{j} T * P(X \ge x | rup_{j})}
\end{align}
The equivalence between equations \ref{eq:hazard_eq_rate} and \ref{eq:hazard_eq_prob} is possible if and only if:
\begin{align}
\label{eq:equivalence_condition_0}
\nu  =  \sum_{i=1}^{I} \sum_{j=1}^{J} \nu_{j} * P(X \ge x | rup_{j})
\end{align}
Assuming now, for the sake of simplicity, that a rupture is completely characterized by magnitude and distance from a site, we
can write the rate of occurrence of the $j-th$ rupture as:
\begin{equation}
\label{eq:rup_rate}
\nu_{j} = \nu_{i} * f_{i}(m, r)
\end{equation}
where $\nu_{i}$ is the total occurrence rate for the $i-th$ source, and $f_{i}(m, r)$ is the probability, for the $i-th$ source, of
generating a rupture of magnitude $m$ and distance $r$. By placing \ref{eq:rup_rate} in \ref{eq:equivalence_condition_0} and
by replacing the discrete summation over ruptures with a continuous integral over magnitude and distance, we can write:
\begin{align}
\nu = \sum_{i=1}^{I} \nu_{i} \iint f_{i}(m, r) P(X \ge x | m, r)\,dm \,dr
\end{align}
which is the traditional equation for calculating ground motion exceedance rates (\cite{mcguire1995}).

\section{Generation of stochastic event sets and ground motion fields for \textit{Event-based} PSHA}
The goal of an \textit{Event-based} PSHA is to simulate seismicity in a region as described by a source model
and to simulate ground shaking on a set of locations accordingly with a ground motion model. In both
cases, simulation invoves on a Monte Carlo (i.e. random) sampling procedure.\\
Seismicity is simulated by generating a \textit{stochastic event set} (also known as \textit{synthetic catalog})
for a given time span $T$. For each source in a source model, and for each rupture generated by a source,
the number of occurrences in a time span $T$ is simulated by sampling the corresponding probability
distribution as given in equation \ref{eq:poisson_pd}. A stochastic event set is therefore a \textit{sample}
of the full population of ruptures as defined by a seismic source model. Each rupture is present zero, one or
more times, depending on its probability. Symbolically, we can define a stochastic event ($SES$) set as:
\begin{align}
SES(T) = \left\{k \times rup,\;k\sim P_{rup}(k | T)\;\;\forall\;rup\;in\;Src\;\forall\;Src\;in\;Source\;Model\right\}
\end{align}
where $k$, the number of occurrences, is a random sample of $P_{rup}(k | T)$, and $k \times rup$ means
that rupture $rup$ is repeated $k$ times in the stochastic event set.

Given an earthquake rupture, the simulation of ground shaking values on a set of locations ($\bm{x}=(x_{1}, x_{2}, ..., x_{N})$)
forms a \textit{ground motion field}. In a \textit{Event-based} PSHA, for each rupture in a stochastic event set,
the ground motion field is obtained by sampling the probability distribution defined by the ground motion model.
As described in Chapter \ref{chap:gmpes}, the ground motion distribution at a site is assumed to be a Normal
distribution. The aleatory variability is described in terms of an \textit{inter-event} (also known as \textit{between-events})
standard deviation ($\tau$) and \text{intra-event} (also known as \textit{within-event}) standard deviation ($\sigma$).
The simulation of a ground motion field is therefore the result of the summation of three terms, the mean of the
ground motion distribution:
\begin{equation}
\bm\mu = (\mu_{1}, \mu_{2}, ..., \mu_{N})
\end{equation}
the inter-event variability:
\begin{equation}
\bm\eta = (\eta, \eta, ..., \eta),\;where\;\eta\sim N(0, \tau)
\end{equation}
and the intra-event variability:
\begin{align}
\bm\epsilon = (\epsilon_{1}, \epsilon_{2}, ..., \epsilon_{N}) \sim N(\bm{0}, \bm\Sigma)
\end{align}
where:
\begin{align}
\bm\Sigma = 
\begin{bmatrix}
\sigma_{1}^2&\sigma_{1}\sigma_{2}\rho_{12}&\cdots &\sigma_{1}\sigma_{N}\rho_{1N} \\
\sigma_{2}\sigma_{1}\rho_{21}&\sigma_{2}^2&\cdots &\sigma_{2}\sigma_{N}\rho_{2N} \\
\vdots & \vdots & \ddots & \vdots\\
\sigma_{N}\sigma_{1}\rho_{N1}&\sigma_{N}\sigma_{2}\rho_{N2}&\cdots &\sigma_{N}^2
\end{bmatrix}
\end{align}
It is worth noticing how the inter-event variability, uniform for all sites given an earthquake rupture, is drawn
from an univariate normal distribution of mean 0 and standard deviation $\tau$, while the intra-event variability
is a random sample of a multivariate normal distribution of mean $\bm{0}$ and covariance matrix $\bm\Sigma$.
$\bm\Sigma$ is a diagonal matrix when considering no-correlation in the intra-event variability, while has non-zero
off-diagonal elements when considering a correlation model for the intra-event aleatory variability.

\subsection{Calculation of hazard curves from ground motion fields}
The ground motion fields simulated for each rupture in a stochastic event set can be used to
compute hazard curves. Indeed, indicating with $T_{0}$ the duration associated with a stochastic
event set, and with $K$ the number of ground motion fields (and associated ruptures) simulated
in time $T_{0}$, we can compute the rate of exceedance of a ground motion level $x$ at a site as (\cite{ebel1999}):
\begin{align}
\label{eq:rate_from_gmfs}
\nu = \frac{\sum_{k=1}^{K}H(x_{k} - x)}{T_{0}}
\end{align}
where $H$ is the Heaviside function and $x_{k}$ is the ground motion parameter value at the considered site associated
with the $k-th$ ground motion field. The exceedance rate obtained from equation \ref{eq:rate_from_gmfs} can then be
used to compute the probability of at least one occurrence in any time span $T$, accordingly with the Poissonian distribution,
using equation \ref{eq:hazard_eq_rate}.\\
As the stochastic event set duration $T_{0}$ increases, equation \ref{eq:rate_from_gmfs}
provides an increasingly more accurrate estimate of the actual rate of exceedance. A larger $T_{0}$ can be achieved
not only by simulating a single stochastic event set with longer duration, but also by simulating multiple
stochastic event sets. These can then be joined together to form a stochastic event which has a large enough
duration to provide a stable estimate of the rates of ground motion exceedance.

\section{Disaggregation analysis}
The disaggregation analysis allows investigating how the different earthquake ruptures defined in a source model
contribute to the probability of exceeding a certain ground motion level $x$ at a given site. Given the very
large number of earthquake ruptures associated with a source model, contributions cannot be investigated on a rupture by
rupture basis but a classification scheme is used instead. Ruptures are classified in terms of the following parameters:
\begin{itemize}
	\item magnitude ($M$)
	\item distance to rupture surface-projection (Joyner-Boore distance) ($r_{jb}$)
	\item longitude and latitude of rupture surface-projection closest point ($\lambda$, $\phi$)
	\item tectonic region type ($TRT$)
\end{itemize}
For each earthquake rupture, the associated conditional probability of exceedance - $P(X \ge x | T, rup)$ - is computed
for different $\epsilon$ bins, where $\epsilon$ is the difference, in terms of number of total standar deviations,
between $x$ and the mean ground motion $\mu$ as predicted by the ground motion model, that is:
\begin{equation}
\epsilon = \frac{x - \mu}{\sigma_{total}}
\end{equation}
The disaggregation in terms of $\epsilon$ allows investigating what are the regions of the ground motion distributions
that are contributing the most to the probability of exceedance.\\
The rupture parameters ($M$, $r_{jb}$, $\lambda$, $\phi$, $TRT$) together with the $\epsilon$ parameter effectively
create a 6-dimensional model space which, discretized into a number of bins, is used to classify the probability
of exceedance for different combination of rupture parameters and $\epsilon$ values.\\
For a given model space bin $\bm{m} = (M, r_{jb}, \lambda, \phi, TRT, \epsilon)$ the probability of
exceeding level $x$ at least once in a time span $T$ is computed using equation \ref{eq:hazard_eq_poiss}, that is:
\begin{align}
\label{eq:disagg}
P(X > x | T, \bm{m}) =
	1 - \prod_{i=1}^{I}\prod_{j=1}^{J}
	\begin{cases} (1 - P_{rup_{j}}(n \ge 1 | T))^{P(X \ge x | rup_{j}, \epsilon)} & \mbox{if}\;rup_{j}\;\in\;\bm{m}\\
			      1 & \mbox{if}\;rup_{j}\;\notin\;\bm{m}
	\end{cases}
\end{align}

\subsection{Disaggregation histograms}
Disaggregation values as given by equation \ref{eq:disagg} can be aggregated in order to investigate earthquake rupture
contributions over a reduced model space.\\
Magnitude disaggregation can be obtained as:
\begin{equation}
P(X > x | T, M) = 1 -\prod_{r_{jb}}\prod_{\lambda}\prod_{\phi}\prod_{TRT} \prod_{\epsilon}(1 - P(X > x | T, \bm{m}))
\end{equation}
Distance disaggregation:
\begin{equation}
P(X > x | T, r_{jb}) = 1 -\prod_{M}\prod_{\lambda}\prod_{\phi}\prod_{TRT} \prod_{\epsilon}(1 - P(X > x | T, \bm{m}))
\end{equation}
Tectonic region type disaggregation:
\begin{equation}
P(X > x | T, TRT) = 1 -\prod_{M}\prod_{r_{jb}}\prod_{\lambda}\prod_{\phi} \prod_{\epsilon}(1 - P(X > x | T, \bm{m}))
\end{equation}
Magnitude-Distance disaggregation:
\begin{equation}
P(X > x | T, M, r_{jb}) = 1 -\prod_{\lambda}\prod_{\phi}\prod_{TRT}\prod_{\epsilon}(1 - P(X > x | T, \bm{m}))
\end{equation}
Magnitude-Distance-Epsilon disaggregation:
\begin{equation}
P(X > x | T, M, r_{jb}, \epsilon) = 1 -\prod_{\lambda}\prod_{\phi}\prod_{TRT}(1 - P(X > x | T, \bm{m}))
\end{equation}
Longitude-Latitude disaggregation:
\begin{equation}
P(X > x | T, \lambda, \phi) = 1 -\prod_{M}\prod_{r_{jb}}\prod_{TRT}\prod_{\epsilon}(1 - P(X > x | T, \bm{m}))
\end{equation}
Longitude-Latitude-Magnitude disaggregation:
\begin{equation}
P(X > x | T, \lambda, \phi, M) = 1 -\prod_{r_{jb}}\prod_{TRT}\prod_{\epsilon}(1 - P(X > x | T, \bm{m}))
\end{equation}
Longitude-Latitude-Tectonic Region Type disaggregation:
\begin{equation}
P(X > x | T, \lambda, \phi, TRT) = 1 -\prod_{M}\prod_{r_{jb}}\prod_{\epsilon}(1 - P(X > x | T, \bm{m}))
\end{equation}

%This chapter contains a general introduction to \gls{acr:sha} and a 
%description of the main concepts needed to understand the hazard calculation 
%methodologies implemented in the OpenQuake-engine.

%\Gls{psha} is a methodology to compute the probability that ground motion, 
%for a site or region, will exceed a given level of intensity in a specified 
%time period. Originally formulated in the classic works of \cite{cornell1968} 
%and \cite{esteva1968}, the fundamental theory of \gls{acr:psha} has remained 
%robust. 
%Over the last four decades there have been many developments that have 
%increased 
%the accuracy and rigour of the process, particularly with respect to the 
%treatment of uncertainties.
%
% ..............................................................................
%\section{Common concepts}
%
%\subsection{Magnitude-frequency distributions}
%\index{Magnitude-frequency distribution}
%
%In statistics a distribution represents an arrangment of the 

%The OpenQuake-engine supports the following \glspl{acr:mfd}:
%\begin{itemize}
%   \item Double-truncated Gutenberg-Richter;
%  \item Evenly-spaced;
%    \item Characteristic \cite{youngs1985}
%\end{itemize}
%
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
%\subsection{Magnitude-scaling relationships}
%
%\glspl{acr:msr} - a fundamental component of a seismic hazard analysis - are 
%empirical functions linking independent an independent variable (e.g. 
%magnitude) to a parameter describing some properties of the earthquake 
%rupture geometry (e.g. area or length).
%
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
%\subsection{Ground-motion prediction equations}
%\index{Ground-motion prediction equation}
%A \gls{acr:gmpe} is an empirical relationship which associates a number of 
%predictive 
%
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
%\subsection{Local soil conditions}
%
% ..............................................................................
%\section{Methodologies for seismic hazard analysis}
%\index{Seismic hazard analysis}
%The hazard integral as implemented in the \gls{acr:oqe}

%\cite{cornell1968}
%\cite{mcguire2004}
%
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
%\subsection{Scenario-based Hazard Analysis}
%\index{Seismic hazard analysis!Scenario-based}
%
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
%
%\subsection{Classical Probabilistic Seismic Hazard Analysis}
%\index{Seismic hazard analysis!Classical PSHA}
%
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
%\subsection{Event-Based Probabilistic Seismic Hazard Analysis}
%\index{Seismic hazard analysis!Event-based PSHA}
%
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
%\subsection{Disaggregation}
%\index{Seismic hazard analysis!Disaggregation}
%
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
%\section{What's missing}
%\subsection{Vector based PSHA}
%\index{Seismic hazard analysis!Vector-based PSHA}
%\subsection{PFDHA}
%\index{Seismic hazard analysis!Probabilistic fault displacement hazard analysis}
%\subsection{PSHA using site-specific transfer functions}
